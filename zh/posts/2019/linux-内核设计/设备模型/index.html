<!DOCTYPE html>
<html lang="en-US" class="has-navbar-fixed-top">

<head>
    <meta name="generator" content="Hugo 0.40.1" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>linux DTS | Hao Jinzhang åšå®¢</title>

     

    
    <meta name="author" content="Hao Jinzhang"> 

    
    
    
    
    
    
    
<meta itemprop="name" content="linux DTS">
<meta itemprop="description" content="æˆ‘æƒ³ä»ä¸‹é¢ä¸‰ä¸ªæ–¹é¢æ¥äº†è§£Device Treeï¼š 1ã€ä¸ºä½•è¦å¼•å…¥Device Treeï¼Œè¿™ä¸ªæœºåˆ¶æ˜¯ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿ 2ã€Device Treeçš„åŸº">


<meta itemprop="datePublished" content="2019-06-26T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-06-26T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="8474">



<meta itemprop="keywords" content="" />

    <meta property="og:title" content="linux DTS" />
<meta property="og:description" content="æˆ‘æƒ³ä»ä¸‹é¢ä¸‰ä¸ªæ–¹é¢æ¥äº†è§£Device Treeï¼š 1ã€ä¸ºä½•è¦å¼•å…¥Device Treeï¼Œè¿™ä¸ªæœºåˆ¶æ˜¯ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿ 2ã€Device Treeçš„åŸº" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhangqi336.github.io./zh/posts/2019/linux-%E5%86%85%E6%A0%B8%E8%AE%BE%E8%AE%A1/%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B/" />



<meta property="article:published_time" content="2019-06-26T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2019-06-26T00:00:00&#43;00:00"/>

<meta property="og:site_name" content="Hao Jinzhang åšå®¢" />









<meta property="og:image" content="https://zhangqi336.github.io./images/og-image.png"/>
    
    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://zhangqi336.github.io./images/og-image.png"/>

<meta name="twitter:title" content="linux DTS"/>
<meta name="twitter:description" content="æˆ‘æƒ³ä»ä¸‹é¢ä¸‰ä¸ªæ–¹é¢æ¥äº†è§£Device Treeï¼š 1ã€ä¸ºä½•è¦å¼•å…¥Device Treeï¼Œè¿™ä¸ªæœºåˆ¶æ˜¯ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿ 2ã€Device Treeçš„åŸº"/>

    
     
    
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-577792-7', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>
 
    
    <link rel="canonical" href="https://zhangqi336.github.io./zh/posts/2019/linux-%E5%86%85%E6%A0%B8%E8%AE%BE%E8%AE%A1/%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B/"> 

     

     
    
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://zhangqi336.github.io./images/favicons/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://zhangqi336.github.io./images/favicons/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://zhangqi336.github.io./images/favicons/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zhangqi336.github.io./images/favicons/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://zhangqi336.github.io./images/favicons/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://zhangqi336.github.io./images/favicons/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://zhangqi336.github.io./images/favicons/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://zhangqi336.github.io./images/favicons/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="https://zhangqi336.github.io./images/favicons/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="https://zhangqi336.github.io./images/favicons/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="https://zhangqi336.github.io./images/favicons/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="https://zhangqi336.github.io./images/favicons/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="https://zhangqi336.github.io./images/favicons/favicon-128.png" sizes="128x128" />
<meta name="msapplication-TileColor" content="#3273dc" />
<meta name="msapplication-TileImage" content="https://zhangqi336.github.io./images/favicons/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="https://zhangqi336.github.io./images/favicons/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="https://zhangqi336.github.io./images/favicons/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="https://zhangqi336.github.io./images/favicons/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="https://zhangqi336.github.io./images/favicons/mstile-310x310.png" />

    
    <link rel="stylesheet" href="/css/bulma.css"> 
    <link rel="stylesheet" href="/css/custom.css"> 
    <link rel="stylesheet" href="/css/font.css">
    <script type="text/javascript" src="/js/bulma.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
  </head>


<body>
    <header> <nav class="navbar is-fixed-top is-link">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/zh">
        <picture style="height:28px;">
          <source srcset="/images/square-logo.webp" type="image/webp">
          <source srcset="/images/square-logo.png" type="image/jpeg">
          <img src="/images/square-logo.png">
      </picture>
      </a>
      <a class="navbar-item" href="/zh">
        Hao Jinzhang åšå®¢
      </a>
      <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div class="navbar-menu" id="navMenu">

      
      
      <div class="navbar-end">
        
        <a class="navbar-item" target="blank" href="https://github.com/zhangqi336.github.io.">
          <span class="icon">
            <i class="icon-github"></i>
          </span>
        </a>
        

        
        <a class="navbar-item" target="blank" href="https://www.linkedin.com/in/Stanley">
          <span class="icon">
            <i class="icon-linkedin-square"></i>
          </span>
        </a>
        
        
        
        <a class="navbar-item" href='/zh/search'>
          <span class="icon">
            <i class="icon-search"></i>
          </span>
        </a>
        <div class="navbar-item">
          
        </div>
      </div>
    </div>
  </div>

</nav> </header>
    <main>

<div class="section">
  <div class="container" itemscope itemtype="http://schema.org/BlogPosting">
    
<meta itemprop="name" content="linux DTS">
<meta itemprop="description" content="æˆ‘æƒ³ä»ä¸‹é¢ä¸‰ä¸ªæ–¹é¢æ¥äº†è§£Device Treeï¼š 1ã€ä¸ºä½•è¦å¼•å…¥Device Treeï¼Œè¿™ä¸ªæœºåˆ¶æ˜¯ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿ 2ã€Device Treeçš„åŸº">


<meta itemprop="datePublished" content="2019-06-26T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-06-26T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="8474">



<meta itemprop="keywords" content="" />

    <div class="columns">
      <div class="column is-8 is-offset-2">
          <div class="columns">
              <div class="column is-8 is-offset-2 has-text-centered">
                <div class="title"><a href="/zh/posts/">æ–‡ç« </a></div>
                <p class="subtitle">linuxå†…æ ¸è®¾è®¡</p>
              </div>
            </div>
            <hr />
        <p class="title">linux DTS</p>
        <div class="columns is-mobile is-vcentered">
          <div class="column has-text-grey has-text-weight-semibold">
            Hao Jinzhang<p class="text is-family-monospace has-text-grey-light">
  
2019-06-26

</p>
          </div>
          <div class="column has-text-right">
            <a class="button is-light" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fzhangqi336.github.io.%2fzh%2fposts%2f2019%2flinux-%25E5%2586%2585%25E6%25A0%25B8%25E8%25AE%25BE%25E8%25AE%25A1%2f%25E8%25AE%25BE%25E5%25A4%2587%25E6%25A8%25A1%25E5%259E%258B%2f" target="_blank" title="åˆ†äº«åˆ°Facebook">
  <span class="icon">
      <i class="icon-facebook"></i>
  </span>
</a>
<a class="button is-light" href="https://www.linkedin.com/sharing/share-offsite?url=https%3a%2f%2fzhangqi336.github.io.%2fzh%2fposts%2f2019%2flinux-%25E5%2586%2585%25E6%25A0%25B8%25E8%25AE%25BE%25E8%25AE%25A1%2f%25E8%25AE%25BE%25E5%25A4%2587%25E6%25A8%25A1%25E5%259E%258B%2f" target="_blank"
  title="åˆ†äº«åˆ°LinkedIn">
  <span class="icon">
      <i class="icon-linkedin"></i>
  </span>
</a>
<a id="open-qr-code" class="button is-light" href="" title="ç”ŸæˆäºŒç»´ç åˆ†äº«">
  <span class="icon">
      <i class="icon-qrcode"></i>
  </span>
</a>
<div class="modal">
  <div class="modal-background"></div>
  <div class="modal-content">
    <p class="image is-1by1">
      <img src="https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=https%3a%2f%2fzhangqi336.github.io.%2fzh%2fposts%2f2019%2flinux-%25E5%2586%2585%25E6%25A0%25B8%25E8%25AE%25BE%25E8%25AE%25A1%2f%25E8%25AE%25BE%25E5%25A4%2587%25E6%25A8%25A1%25E5%259E%258B%2f&choe=UTF-8" alt="">
    </p>
  </div>
  <button class="modal-close is-large" aria-label="close"></button>
</div>
<script>
  document.querySelector('a#open-qr-code').addEventListener('click', function (event) {
    event.preventDefault();
    var modal = document.querySelector('.modal');
    var html = document.querySelector('html');
    modal.classList.add('is-active');
    html.classList.add('is-clipped');

    modal.querySelector('.modal-background').addEventListener('click', function (e) {
      e.preventDefault();
      modal.classList.remove('is-active');
      html.classList.remove('is-clipped');
    });

    modal.querySelector('.modal-close').addEventListener('click', function (e) {
      e.preventDefault();
      modal.classList.remove('is-active');
      html.classList.remove('is-clipped');
    });
  });
</script>
          </div>
        </div>
        <div class="content">
          

          

<p>æˆ‘æƒ³ä»ä¸‹é¢ä¸‰ä¸ªæ–¹é¢æ¥äº†è§£Device Treeï¼š</p>

<p>1ã€ä¸ºä½•è¦å¼•å…¥Device Treeï¼Œè¿™ä¸ªæœºåˆ¶æ˜¯ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜çš„ï¼Ÿ</p>

<p>2ã€Device Treeçš„åŸºç¡€æ¦‚å¿µã€‚</p>

<p>3ã€ARM linuxä¸­å’ŒDevice Treeç›¸å…³çš„ä»£ç åˆ†æã€‚</p>

<h1 id="ä¸€-èƒŒæ™¯">ä¸€ã€ èƒŒæ™¯</h1>

<p>åœ¨å¼•å…¥è®¾å¤‡æ ‘å‰ï¼Œå†…æ ¸ä¸­å­˜åœ¨å¤§é‡çš„å„ä¸ªboard specificçš„æºä»£ç ï¼Œè¿™äº›æºä»£ç ç»™linuxå†…æ ¸çš„ç»´æŠ¤å’Œå‘å±•å¸¦æ¥çš„è¾ƒå¤§çš„å·¥ä½œé‡ï¼Œå¢å¤§äº†å†…æ ¸ç»´æŠ¤çš„å›°éš¾ç¨‹åº¦ï¼Œäºæ˜¯æœ‰äººæå‡ºåº”è¯¥æŠŠboard specificçš„æºä»£ç è¸¢å‡ºkernelã€‚æ‰€ä»¥è®¾å¤‡æ ‘çš„æœºåˆ¶è¢«æäº†å‡ºæ¥ã€‚è®¾å¤‡æ ‘åœ¨æœ¬è´¨ä¸Šæ”¹å˜äº†åŸæ¥ç”¨hardcodeæ–¹å¼å°†HW é…ç½®ä¿¡æ¯åµŒå…¥åˆ°å†…æ ¸ä»£ç çš„æ–¹æ³•ï¼Œæ”¹ç”¨bootloaderä¼ é€’ä¸€ä¸ªDBçš„å½¢å¼ï¼Œè¿™æ ·å¯ä»¥ç»™kernelå¸¦æ¥è¾ƒå¤§çš„çµæ´»æ€§ï¼ŒDevice Treeçš„è®¾è®¡ç›®æ ‡å°±æ˜¯å¦‚æ­¤ã€‚</p>

<p>åœ¨æè¿°Device Treeçš„ç»“æ„ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆé—®ä¸€ä¸ªåŸºç¡€é—®é¢˜ï¼šæ˜¯å¦Device Treeè¦æè¿°ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç¡¬ä»¶ä¿¡æ¯ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚åŸºæœ¬ä¸Šï¼Œé‚£äº›å¯ä»¥åŠ¨æ€æ¢æµ‹åˆ°çš„è®¾å¤‡æ˜¯ä¸éœ€è¦æè¿°çš„ï¼Œä¾‹å¦‚USB deviceã€‚ä¸è¿‡å¯¹äºSOCä¸Šçš„usb host controllerï¼Œå®ƒæ˜¯æ— æ³•åŠ¨æ€è¯†åˆ«çš„ï¼Œéœ€è¦åœ¨device treeä¸­æè¿°ã€‚åŒæ ·çš„é“ç†ï¼Œåœ¨computer systemä¸­ï¼ŒPCI deviceå¯ä»¥è¢«åŠ¨æ€æ¢æµ‹åˆ°ï¼Œä¸éœ€è¦åœ¨device treeä¸­æè¿°ï¼Œä½†æ˜¯PCI bridgeå¦‚æœä¸èƒ½è¢«æ¢æµ‹ï¼Œé‚£ä¹ˆå°±éœ€è¦æè¿°ä¹‹ã€‚</p>

<p># äºŒã€åŸºæœ¬ç»“æ„<br />
   ä¸ºäº†äº†è§£Device Treeçš„ç»“æ„ï¼Œæˆ‘ä»¬é¦–å…ˆç»™å‡ºä¸€ä¸ªDevice Treeçš„ç¤ºä¾‹ï¼š</p>

<blockquote>
<p>/ o device-tree<br />
      |- name = &ldquo;device-tree&rdquo;<br />
      |- model = &ldquo;MyBoardName&rdquo;<br />
      |- compatible = &ldquo;MyBoardFamilyName&rdquo;<br />
      |- #address-cells = <2><br />
      |- #size-cells = <2><br />
      |- linux,phandle = <0><br />
      |<br />
      o cpus<br />
      | | - name = &ldquo;cpus&rdquo;<br />
      | | - linux,phandle = <1><br />
      | | - #address-cells = <1><br />
      | | - #size-cells = <0><br />
      | |<br />
      | o PowerPC,970@0<br />
      |   |- name = &ldquo;PowerPC,970&rdquo;<br />
      |   |- device_type = &ldquo;cpu&rdquo;<br />
      |   |- reg = <0><br />
      |   |- clock-frequency = <0x5f5e1000><br />
      |   |- 64-bit<br />
      |   |- linux,phandle = <2><br />
      |<br />
      o memory@0<br />
      | |- name = &ldquo;memory&rdquo;<br />
      | |- device_type = &ldquo;memory&rdquo;<br />
      | |- reg = <0x00000000 0x00000000 0x00000000 0x20000000><br />
      | |- linux,phandle = <3><br />
      |<br />
      o chosen<br />
        |- name = &ldquo;chosen&rdquo;<br />
        |- bootargs = &ldquo;root=/dev/sda2&rdquo;<br />
        |- linux,phandle = <4></p>
</blockquote>

<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œdevice treeçš„åŸºæœ¬å•å…ƒæ˜¯nodeã€‚è¿™äº›nodeè¢«ç»„ç»‡æˆæ ‘çŠ¶ç»“æ„ï¼Œé™¤äº†root nodeï¼Œæ¯ä¸ªnodeéƒ½åªæœ‰ä¸€ä¸ªparentã€‚ä¸€ä¸ªdevice treeæ–‡ä»¶ä¸­åªèƒ½æœ‰ä¸€ä¸ªroot nodeã€‚æ¯ä¸ªnodeä¸­åŒ…å«äº†è‹¥å¹²çš„property/valueæ¥æè¿°è¯¥nodeçš„ä¸€äº›ç‰¹æ€§ã€‚æ¯ä¸ªnodeç”¨èŠ‚ç‚¹åå­—ï¼ˆnode nameï¼‰æ ‡è¯†ï¼ŒèŠ‚ç‚¹åå­—çš„æ ¼å¼æ˜¯node-name@unit-addressã€‚å¦‚æœè¯¥nodeæ²¡æœ‰regå±æ€§ï¼ˆåé¢ä¼šæè¿°è¿™ä¸ªpropertyï¼‰ï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹åå­—ä¸­å¿…é¡»ä¸èƒ½åŒ…æ‹¬@å’Œunit-addressã€‚unit-addressçš„å…·ä½“æ ¼å¼æ˜¯å’Œè®¾å¤‡æŒ‚åœ¨é‚£ä¸ªbusä¸Šç›¸å…³ã€‚ä¾‹å¦‚å¯¹äºcpuï¼Œå…¶unit-addresså°±æ˜¯ä»0å¼€å§‹ç¼–å€ï¼Œä»¥æ­¤åŠ ä¸€ã€‚è€Œå…·ä½“çš„è®¾å¤‡ï¼Œä¾‹å¦‚ä»¥å¤ªç½‘æ§åˆ¶å™¨ï¼Œå…¶unit-addresså°±æ˜¯å¯„å­˜å™¨åœ°å€ã€‚root nodeçš„node nameæ˜¯ç¡®å®šçš„ï¼Œå¿…é¡»æ˜¯â€œ/â€ã€‚</p>

<blockquote>
<p>/ {<br />
    compatible = &ldquo;samsung,s3c24xx&rdquo;; ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆAï¼‰<br />
    interrupt-parent = &lt;&amp;intc&gt;; ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆBï¼‰<br />
    aliases {<br />
        pinctrl0 = &amp;pinctrl_0; ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆCï¼‰<br />
    };<br />
    intc:interrupt-controller@4a000000 { ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆDï¼‰<br />
        compatible = &ldquo;samsung,s3c2410-irq&rdquo;;<br />
        reg = <0x4a000000 0x100>;<br />
        interrupt-controller;<br />
        #interrupt-cells = <4>;<br />
    };<br />
    serial@50000000 { ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆEï¼‰<br />
        compatible = &ldquo;samsung,s3c2410-uart&rdquo;;<br />
        reg = <0x50000000 0x4000>;<br />
        interrupts = <1 0 4 28>, <1 1 4 28>;<br />
        status = &ldquo;disabled&rdquo;;<br />
    };<br />
    pinctrl_0: pinctrl@56000000 {ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ˆFï¼‰<br />
        reg = <0x56000000 0x1000>;<br />
        wakeup-interrupt-controller {<br />
            compatible = &ldquo;samsung,s3c2410-wakeup-eint&rdquo;;<br />
            interrupts = <0 0 0 3>,<br />
                     <0 0 1 3>,<br />
                     <0 0 2 3>,<br />
                     <0 0 3 3>,<br />
                     <0 0 4 4>,<br />
                     <0 0 5 4>;<br />
        };<br />
    };<br />
â€¦â€¦<br />
};</p>
</blockquote>

<p>ï¼ˆAï¼‰åœ¨æè¿°compatibleå±æ€§ä¹‹å‰è¦å…ˆæè¿°modelå±æ€§ã€‚modelå±æ€§æŒ‡æ˜äº†è¯¥è®¾å¤‡å±äºå“ªä¸ªè®¾å¤‡ç”Ÿäº§å•†çš„å“ªä¸€ä¸ªmodelã€‚ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä¼šç»™modelèµ‹å€¼â€œmanufacturer,modelâ€ã€‚ä¾‹å¦‚model = &ldquo;samsung,s3c24xx&rdquo;ã€‚samsungæ˜¯ç”Ÿäº§å•†ï¼Œs3c24xxæ˜¯modelç±»å‹ï¼ŒæŒ‡æ˜äº†å…·ä½“çš„æ˜¯å“ªä¸€ä¸ªç³»åˆ—çš„SOCã€‚OKï¼Œç°åœ¨æˆ‘ä»¬å›åˆ°compatibleå±æ€§ï¼Œè¯¥å±æ€§çš„å€¼æ˜¯string listï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—çš„modleï¼ˆæ¯ä¸ªstringæ˜¯ä¸€ä¸ªmodelï¼‰ã€‚è¿™äº›å­—ç¬¦ä¸²åˆ—è¡¨è¢«æ“ä½œç³»ç»Ÿç”¨æ¥é€‰æ‹©ç”¨å“ªä¸€ä¸ªdriveræ¥é©±åŠ¨è¯¥è®¾å¤‡ã€‚å‡è®¾å®šä¹‰è¯¥å±æ€§ï¼šcompatible = â€œaaaaaaâ€, â€œbbbbb&rdquo;ã€‚é‚£ä¹ˆæ“ä½œæ“ä½œç³»ç»Ÿå¯èƒ½é¦–å…ˆä½¿ç”¨aaaaaaæ¥åŒ¹é…é€‚åˆçš„driverï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œé‚£ä¹ˆä½¿ç”¨å­—ç¬¦ä¸²bbbbbæ¥ç»§ç»­å¯»æ‰¾é€‚åˆçš„driverï¼Œå¯¹äºæœ¬ä¾‹ï¼Œcompatible = &ldquo;samsung,s3c24xx&rdquo;ï¼Œè¿™é‡Œåªå®šä¹‰äº†ä¸€ä¸ªmodleè€Œä¸æ˜¯ä¸€ä¸ªlistã€‚å¯¹äºroot nodeï¼Œcompatibleå±æ€§æ˜¯ç”¨æ¥åŒ¹é…machine typeçš„ï¼ˆåœ¨device treeä»£ç åˆ†ææ–‡ç« ä¸­ä¼šç»™å‡ºæ›´ç»†è‡´çš„æè¿°ï¼‰ã€‚å¯¹äºæ™®é€šçš„HW blockçš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚interrupt-controllerï¼Œcompatibleå±æ€§æ˜¯ç”¨æ¥åŒ¹é…é€‚åˆçš„driverçš„ã€‚</p>

<p>ï¼ˆBï¼‰å…·ä½“å„ä¸ªHW blockçš„interrupt sourceæ˜¯å¦‚ä½•ç‰©ç†çš„è¿æ¥åˆ°interruptcontrollerçš„å‘¢ï¼Ÿåœ¨dtsæ–‡ä»¶ä¸­æ˜¯ç”¨interrupt-parentè¿™ä¸ªå±æ€§æ¥æ ‡è¯†çš„ã€‚ä¸”æ…¢ï¼Œè¿™é‡Œå®šä¹‰interrupt-parentå±æ€§çš„æ˜¯root nodeï¼Œéš¾é“root nodeä¼šäº§ç”Ÿä¸­æ–­åˆ°interrupt controllerå—ï¼Ÿå½“ç„¶ä¸ä¼šï¼Œåªä¸è¿‡å¦‚æœä¸€ä¸ªèƒ½å¤Ÿäº§ç”Ÿä¸­æ–­çš„device nodeæ²¡æœ‰å®šä¹‰interrupt-parentçš„è¯ï¼Œå…¶interrupt-parentå±æ€§å°±æ˜¯è·Ÿéšparent nodeã€‚å› æ­¤ï¼Œä¸å…¶åœ¨æ‰€æœ‰çš„ä¸‹æ¸¸è®¾å¤‡ä¸­å®šä¹‰interrupt-parentï¼Œä¸å¦‚ç»Ÿä¸€åœ¨root nodeä¸­å®šä¹‰äº†ã€‚</p>

<p>intcæ˜¯ä¸€ä¸ªlableï¼Œæ ‡è¯†äº†ä¸€ä¸ªdevice nodeï¼ˆåœ¨æœ¬ä¾‹ä¸­æ˜¯æ ‡è¯†äº†interrupt-controller@4a000000 è¿™ä¸ªdevice nodeï¼‰ã€‚å®é™…ä¸Šï¼Œinterrupt-parentå±æ€§å€¼åº”è¯¥æ˜¯æ˜¯ä¸€ä¸ªu32çš„æ•´æ•°å€¼ï¼ˆè¿™ä¸ªæ•´æ•°å€¼åœ¨Device Treeçš„èŒƒå›´å†…å”¯ä¸€è¯†åˆ«äº†ä¸€ä¸ªdevice nodeï¼Œä¹Ÿå°±æ˜¯phandleï¼‰ï¼Œä¸è¿‡ï¼Œåœ¨dtsæ–‡ä»¶ä¸­ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼cè¯­è¨€çš„Labels and Referencesæœºåˆ¶ã€‚å®šä¹‰ä¸€ä¸ªlableï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ªnodeæˆ–è€…propertyï¼Œåç»­å¯ä»¥ä½¿ç”¨&amp;æ¥å¼•ç”¨è¿™ä¸ªlableã€‚DTCä¼šå°†lableè½¬æ¢æˆu32çš„æ•´æ•°å€¼æ”¾å…¥åˆ°DTBä¸­ï¼Œç”¨æˆ·å±‚é¢å°±ä¸å†å…³å¿ƒå…·ä½“è½¬æ¢çš„æ•´æ•°å€¼äº†ã€‚</p>

<p>å…³äºinterruptï¼Œæˆ‘ä»¬å€¼å¾—è¿›ä¸€æ­¥æè¿°ã€‚åœ¨Device Treeä¸­ï¼Œæœ‰ä¸€ä¸ªæ¦‚å¿µå«åšinterrupt treeï¼Œä¹Ÿå°±æ˜¯è¯´interruptä¹Ÿæ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ã€‚æˆ‘ä»¬ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼ˆè¯¥å›¾æ¥è‡ªPower_ePAPR_APPROVED_v1.1ï¼‰ï¼š</p>

<p><img src="./interrupt_tree.gif" alt="interrupt_tree" />.</p>

<p>ç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªinterrrupt treeçš„æ ¹èŠ‚ç‚¹ï¼Œdevice1ã€device2ä»¥åŠPCI host bridgeçš„interrupt lineéƒ½æ˜¯è¿æ¥åˆ°root interrupt controllerçš„ã€‚PCI host bridgeè®¾å¤‡ä¸­æœ‰ä¸€äº›ä¸‹æ¸¸çš„è®¾å¤‡ï¼Œä¹Ÿä¼šäº§ç”Ÿä¸­æ–­ï¼Œä½†æ˜¯ä»–ä»¬çš„ä¸­æ–­éƒ½æ˜¯è¿æ¥åˆ°PCI host bridgeä¸Šçš„interrupt controllerï¼ˆæœ¯è¯­å«åšinterrupt nexusï¼‰ï¼Œç„¶åæŠ¥å‘Šåˆ°root interrupt controllerçš„ã€‚æ¯ä¸ªèƒ½äº§ç”Ÿä¸­æ–­çš„è®¾å¤‡éƒ½å¯ä»¥äº§ç”Ÿä¸€ä¸ªæˆ–è€…å¤šä¸ªinterruptï¼Œæ¯ä¸ªinterrupt sourceï¼ˆå¦å¤–ä¸€ä¸ªæœ¯è¯­å«åšinterrupt specifierï¼Œæè¿°äº†interrupt sourceçš„ä¿¡æ¯ï¼‰éƒ½æ˜¯é™å®šåœ¨å…¶æ‰€å±çš„interrupt domainä¸­ã€‚</p>

<p>åœ¨äº†è§£äº†ä¸Šè¿°çš„æ¦‚å¿µåï¼Œæˆ‘ä»¬å¯ä»¥å›å¤´å†çœ‹çœ‹interrupt-parentè¿™ä¸ªå±æ€§ã€‚å…¶å®è¿™ä¸ªå±æ€§æ˜¯å»ºç«‹interrupt treeçš„å…³é”®å±æ€§ã€‚å®ƒæŒ‡æ˜äº†è®¾å¤‡æ ‘ä¸­çš„å„ä¸ªdevice nodeå¦‚ä½•è·¯ç”±interrupt eventã€‚å¦å¤–ï¼Œéœ€è¦æé†’çš„æ˜¯interrupt controllerä¹Ÿæ˜¯å¯ä»¥çº§è”çš„ï¼Œä¸Šå›¾ä¸­æ²¡æœ‰è¡¨ç¤ºå‡ºæ¥ã€‚é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹å¦‚ä½•å®šä¹‰interrupt treeçš„rootå‘¢ï¼Ÿé‚£ä¸ªæ²¡æœ‰å®šä¹‰interrupt-parentçš„interrupt controllerå°±æ˜¯rootã€‚</p>

<p>ï¼ˆCï¼‰pinctrl0æ˜¯ä¸€ä¸ªç¼©å†™ï¼Œä»–æ˜¯/pinctrl@56000000çš„åˆ«åã€‚è¿™é‡ŒåŒæ ·ä¹Ÿæ˜¯ä½¿ç”¨äº†Labels and Referencesæœºåˆ¶ã€‚</p>

<p>ï¼ˆDï¼‰intcï¼ˆnode nameæ˜¯interrupt-controller@4a000000 ï¼Œæˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨lableï¼‰æ˜¯æè¿°interrupt controllerçš„device nodeã€‚æ ¹æ®S3C24xxçš„datasheetï¼Œæˆ‘ä»¬çŸ¥é“interrupt controllerçš„å¯„å­˜å™¨åœ°å€ä»0x4a000000å¼€å§‹ï¼Œé•¿åº¦ä¸º0x100ï¼ˆå®é™…2451çš„interruptçš„å¯„å­˜å™¨åœ°å€ç©ºé—´æ²¡æœ‰é‚£ä¹ˆé•¿ï¼Œ0x4a000074æ˜¯æœ€åä¸€ä¸ªå¯„å­˜å™¨ï¼‰ï¼Œä¹Ÿå°±æ˜¯regå±æ€§å®šä¹‰çš„å†…å®¹ã€‚interrupt-controllerå±æ€§ä¸ºç©ºï¼Œåªæ˜¯ç”¨æ¥æ ‡è¯†è¯¥nodeæ˜¯ä¸€ä¸ªinterrupt controllerè€Œä¸æ˜¯interrupt nexusï¼ˆinterrupt nexuséœ€è¦åœ¨ä¸åŒçš„interrupt domainsä¹‹é—´è¿›è¡Œç¿»è¯‘ï¼Œéœ€è¦å®šä¹‰interrupt-mapçš„å±æ€§ï¼Œæœ¬æ–‡ä¸æ¶‰åŠè¿™éƒ¨åˆ†çš„å†…å®¹ï¼‰ã€‚#interrupt-cells å’Œ#address-cellsæ¦‚å¿µæ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨å¤šå°‘ä¸ªu32æ¥æ ‡è¯†ä¸€ä¸ªinterrupt sourceã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å…·ä½“HW blockçš„interruptå®šä¹‰ä¸­éƒ½æ˜¯ç”¨äº†4ä¸ªu32æ¥è¡¨ç¤ºï¼Œä¾‹å¦‚ä¸²å£çš„ä¸­æ–­æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š</p>

<p>interrupts = <1 0 4 28>, <1 1 4 28>;<br />
ï¼ˆEï¼‰ ä»regå±æ€§å¯ä»¥serial controllerå¯„å­˜å™¨åœ°å€ä»0x50000000 å¼€å§‹ï¼Œé•¿åº¦ä¸º0x4000ã€‚å¯¹äºä¸€ä¸ªèƒ½äº§ç”Ÿä¸­æ–­çš„è®¾å¤‡ï¼Œå¿…é¡»å®šä¹‰interruptsè¿™ä¸ªå±æ€§ã€‚ä¹Ÿå¯ä»¥å®šä¹‰interrupt-parentè¿™ä¸ªå±æ€§ï¼Œå¦‚æœä¸å®šä¹‰ï¼Œåˆ™ç»§æ‰¿å…¶parent nodeçš„interrupt-parentå±æ€§ã€‚ å¯¹äºinterruptå±æ€§å€¼ï¼Œå„ä¸ªinterrupt controllerå®šä¹‰æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ‰çš„ç”¨3ä¸ªu32è¡¨ç¤ºï¼Œæœ‰çš„ç”¨4ä¸ªã€‚å…·ä½“ä¸Šé¢çš„å„ä¸ªæ•°å­—çš„è§£é‡Šæƒå½’ç›¸å…³çš„interrupt controlleræ‰€æœ‰ã€‚å¯¹äºä¸­æ–­å±æ€§çš„å…·ä½“å€¼çš„æè¿°æˆ‘ä»¬ä¼šåœ¨device treeçš„ç¬¬ä¸‰ä»½æ–‡æ¡£ï¼ä»£ç åˆ†æä¸­æè¿°ã€‚</p>

<p>ï¼ˆFï¼‰è¿™ä¸ªnodeæ˜¯æè¿°GPIOæ§åˆ¶çš„ã€‚è¿™ä¸ªèŠ‚ç‚¹å®šä¹‰äº†ä¸€ä¸ªwakeup-interrupt-controller çš„å­èŠ‚ç‚¹ï¼Œç”¨æ¥æè¿°æœ‰å”¤é†’åŠŸèƒ½çš„ä¸­æ–­æºã€‚</p>

<p>DTBæ•´ä½“ç»“æ„</p>

<p>ç»è¿‡Device Tree Compilerç¼–è¯‘ï¼ŒDevice Tree source fileå˜æˆäº†Device Tree Blobï¼ˆåˆç§°ä½œflattened device treeï¼‰çš„æ ¼å¼ã€‚Device Tree Blobçš„æ•°æ®ç»„ç»‡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="./dtb.gif" alt="dtb" />.</p>

<p><1> DTB header<br />
 å¯¹äºDTB headerï¼Œå…¶å„ä¸ªæˆå‘˜è§£é‡Šå¦‚ä¸‹ï¼š</p>

<p>ğŸ‘‰header field name     (description)<br />
ğŸ‘‰magic      (ç”¨æ¥è¯†åˆ«DTBçš„ã€‚é€šè¿‡è¿™ä¸ªmagicï¼Œkernelå¯ä»¥ç¡®å®šbootloaderä¼ é€’çš„å‚æ•°blockæ˜¯ä¸€ä¸ªDTBè¿˜æ˜¯tag list)</p>

<p>ğŸ‘‰totalsize   (DTBçš„total size)</p>

<p>ğŸ‘‰off_dt_struct  ï¼ˆdevice tree structure blockçš„offsetï¼‰</p>

<p>ğŸ‘‰off_dt_strings ï¼ˆdevice tree strings blockçš„offsetï¼‰</p>

<p>ğŸ‘‰off_mem_rsvmap ï¼ˆoffset to memory reserve mapã€‚æœ‰äº›ç³»ç»Ÿï¼Œæˆ‘ä»¬ä¹Ÿè®¸ä¼šä¿ç•™ä¸€äº›memoryæœ‰ç‰¹æ®Šç”¨é€”ï¼ˆä¾‹å¦‚DTBæˆ–è€…initrd imageï¼‰ï¼Œæˆ–è€…åœ¨æœ‰äº›DSP+ARMçš„SOC platformä¸Šï¼Œæœ‰å†™memoryè¢«ä¿ç•™ç”¨äºARMå’ŒDSPè¿›è¡Œä¿¡æ¯äº¤äº’ã€‚è¿™äº›ä¿ç•™å†…å­˜ä¸ä¼šè¿›å…¥å†…å­˜ç®¡ç†ç³»ç»Ÿï¼‰</p>

<p>ğŸ‘‰version    ï¼ˆè¯¥DTBçš„ç‰ˆæœ¬ï¼‰</p>

<p>ğŸ‘‰last_comp_version  ï¼ˆå…¼å®¹ç‰ˆæœ¬ä¿¡æ¯ï¼‰</p>

<p>ğŸ‘‰boot_cpuid_phys    ï¼ˆæˆ‘ä»¬åœ¨å“ªä¸€ä¸ªCPUï¼ˆç”¨IDæ ‡è¯†ï¼‰ä¸Šbootingï¼‰<br />
ğŸ‘‰dt_strings_size    ï¼ˆdevice tree strings blockçš„sizeã€‚å’Œoff_dt_stringsä¸€èµ·ç¡®å®šäº†strings blockåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼‰</p>

<p>dt_struct_size     ï¼ˆ device tree structure blockçš„sizeã€‚å’Œoff_dt_structä¸€èµ·ç¡®å®šäº†device tree structure blockåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼‰</p>

<p><2> memory reserve mapçš„æ ¼å¼æè¿°</p>

<p>è¿™ä¸ªåŒºåŸŸåŒ…æ‹¬äº†è‹¥å¹²çš„reserve memoryæè¿°ç¬¦ã€‚æ¯ä¸ªreserve memoryæè¿°ç¬¦æ˜¯ç”±addresså’Œsizeç»„æˆã€‚å…¶ä¸­addresså’Œsizeéƒ½æ˜¯ç”¨U64æ¥æè¿°ã€‚</p>

<p><3> device tree structure blockçš„æ ¼å¼æè¿°</p>

<p>device tree structure blockåŒºåŸŸæ˜¯ç”±è‹¥å¹²çš„åˆ†ç‰‡ç»„æˆï¼Œæ¯ä¸ªåˆ†ç‰‡å¼€å§‹ä½ç½®éƒ½æ˜¯ä¿å­˜äº†tokenï¼Œä»¥æ­¤æ¥æè¿°è¯¥åˆ†ç‰‡çš„å±æ€§å’Œå†…å®¹ã€‚å…±è®¡æœ‰5ç§tokenï¼š</p>

<p>ï¼ˆ1ï¼‰FDT_BEGIN_NODE (0x00000001)ã€‚è¯¥tokenæè¿°äº†ä¸€ä¸ªnodeçš„å¼€å§‹ä½ç½®ï¼Œç´§æŒ¨ç€è¯¥tokençš„å°±æ˜¯node nameï¼ˆåŒ…æ‹¬unit addressï¼‰</p>

<p>ï¼ˆ2ï¼‰FDT_END_NODE (0x00000002)ã€‚è¯¥tokenæè¿°äº†ä¸€ä¸ªnodeçš„ç»“æŸä½ç½®ã€‚</p>

<p>ï¼ˆ3ï¼‰FDT_PROP (0x00000003)ã€‚è¯¥tokenæè¿°äº†ä¸€ä¸ªpropertyçš„å¼€å§‹ä½ç½®ï¼Œè¯¥tokenä¹‹åæ˜¯ä¸¤ä¸ªu32çš„æ•°æ®ï¼Œåˆ†åˆ«æ˜¯lengthå’Œname offsetã€‚lengthè¡¨ç¤ºè¯¥property value dataçš„sizeã€‚name offsetè¡¨ç¤ºè¯¥å±æ€§å­—ç¬¦ä¸²åœ¨device tree strings blockçš„åç§»å€¼ã€‚lengthå’Œname offsetä¹‹åå°±æ˜¯é•¿åº¦ä¸ºlengthå…·ä½“çš„å±æ€§å€¼æ•°æ®ã€‚</p>

<p>ï¼ˆ4ï¼‰FDT_NOP (0x00000004)ã€‚</p>

<p>ï¼ˆ5ï¼‰FDT_END (0x00000009)ã€‚è¯¥tokenæ ‡è¯†äº†ä¸€ä¸ªDTBçš„ç»“æŸä½ç½®ã€‚</p>

<p>ä¸€ä¸ªå¯èƒ½çš„DTBçš„ç»“æ„å¦‚ä¸‹ï¼š</p>

<p>ï¼ˆ1ï¼‰è‹¥å¹²ä¸ªFDT_NOPï¼ˆå¯é€‰ï¼‰</p>

<p>ï¼ˆ2ï¼‰FDT_BEGIN_NODE</p>

<pre><code> node name
 paddings
</code></pre>

<p>ï¼ˆ3ï¼‰è‹¥å¹²å±æ€§å®šä¹‰ã€‚</p>

<p>ï¼ˆ4ï¼‰è‹¥å¹²å­èŠ‚ç‚¹å®šä¹‰ã€‚ï¼ˆè¢«FDT_BEGIN_NODEå’ŒFDT_END_NODEåŒ…å›´ï¼‰</p>

<p>ï¼ˆ5ï¼‰è‹¥å¹²ä¸ªFDT_NOPï¼ˆå¯é€‰ï¼‰</p>

<p>ï¼ˆ6ï¼‰FDT_END_NODE</p>

<p>ï¼ˆ7ï¼‰FDT_END</p>

<p><4> device tree strings blocçš„æ ¼å¼æè¿°</p>

<p>device tree strings blocå®šä¹‰äº†å„ä¸ªnodeä¸­ä½¿ç”¨çš„å±æ€§çš„å­—ç¬¦ä¸²è¡¨ã€‚ç”±äºå¾ˆå¤šå±æ€§ä¼šå‡ºç°åœ¨å¤šä¸ªnodeä¸­ï¼Œå› æ­¤ï¼Œæ‰€æœ‰çš„å±æ€§å­—ç¬¦ä¸²ç»„æˆäº†ä¸€ä¸ªstring blockã€‚è¿™æ ·å¯ä»¥å‹ç¼©DTBçš„sizeã€‚</p>

<h2 id="ä¸‰-ä»£ç åˆ†æ">ä¸‰ã€ä»£ç åˆ†æ</h2>

<p>ä»‹ç»Device Treeç›¸å…³çš„æ•°æ®æµï¼Œå¯¹å¯¹ARM linux kernelçš„ä»£ç è¿›è¡Œè§£æã€‚æ•°æ®æµåŒ…æ‹¬ï¼š<br />
  1ã€åˆå§‹åŒ–æµç¨‹ã€‚ä¹Ÿå°±æ˜¯æ‰«ædtbå¹¶å°†å…¶è½¬æ¢æˆDevice Tree Structureã€‚<br />
  2ã€ä¼ é€’è¿è¡Œæ—¶å‚æ•°ä¼ é€’ä»¥åŠplatformçš„è¯†åˆ«æµç¨‹åˆ†æ<br />
  3ã€å¦‚ä½•å°†Device Tree Structureå¹¶å…¥linux kernelçš„è®¾å¤‡é©±åŠ¨æ¨¡å‹ã€‚</p>

<p><1> Device Treeå®Œæˆè¿è¡Œæ—¶å‚æ•°ä¼ é€’ä»¥åŠplatformçš„è¯†åˆ«åŠŸèƒ½<br />
   dtbåœ°å€çš„ä¼ é€’å¯ä»¥é€šè¿‡bootloaderå‘Šè¯‰å†…æ ¸ï¼ˆCONFIG_ARM_ATAG_DTB_COMPATï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨åˆ¶ä½œå†…æ ¸é•œåƒçš„æ—¶å€™å¼•è¿› CONFIG_ARM_APPENDED_DTBå‘Šè¯‰å†…æ ¸åœ¨ç´§è·Ÿç€å†…æ ¸çš„åœ°å€é‡ŒæŸ¥æ‰¾DTBæ–‡ä»¶ï¼ˆcat arch/arm/boot/dts/at91sam9x35ek.dtb &gt;&gt; arch/arm/boot/zImageï¼‰ï¼Œå†…æ ¸ä¸­å¯¹DTBç»“æ„çš„å¤„ç†æµç¨‹ä»ä»¥ä¸‹å‡½æ•°å¼€å§‹(start_kernel()-&gt;setup_arch()-&gt;setup_machine_fdt()-&gt;early_init_dt_scan_nodes())</p>

<blockquote>
<p>void <strong>init setup_arch(char **cmdline_p)<br />
{<br />
    const struct machine_desc *mdesc;<br />
â€¦â€¦<br />
    mdesc = setup_machine_fdt(</strong>atags_pointer);<br />
    if (!mdesc)<br />
        mdesc = setup_machine_tags(__atags_pointer, __machine_arch_type);<br />
    machine_desc = mdesc;<br />
    machine_name = mdesc-&gt;name;<br />
â€¦â€¦<br />
}</p>
</blockquote>

<p>å¯¹äºå¦‚ä½•ç¡®å®šHW platformè¿™ä¸ªé—®é¢˜ï¼Œæ—§çš„æ–¹æ³•æ˜¯é™æ€å®šä¹‰è‹¥å¹²çš„machineæè¿°ç¬¦ï¼ˆstruct machine_desc ï¼‰ï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡machine type IDä½œä¸ºç´¢å¼•ï¼Œåœ¨è¿™äº›é™æ€å®šä¹‰çš„machineæè¿°ç¬¦ä¸­æ‰«æï¼Œæ‰¾åˆ°é‚£ä¸ªIDåŒ¹é…çš„æè¿°ç¬¦ã€‚åœ¨æ–°çš„å†…æ ¸ä¸­ï¼Œé¦–å…ˆä½¿ç”¨setup_machine_fdtæ¥setup machineæè¿°ç¬¦ï¼Œå¦‚æœè¿”å›NULLï¼Œæ‰ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹æ³•setup_machine_tagsæ¥setup machineæè¿°ç¬¦ã€‚ä¼ ç»Ÿçš„æ–¹æ³•éœ€è¦ç»™å‡º<strong>machine_arch_typeï¼ˆbootloaderé€šè¿‡r1å¯„å­˜å™¨ä¼ é€’ç»™kernelçš„ï¼‰å’Œtag listçš„åœ°å€ï¼ˆç”¨æ¥è¿›è¡Œtag parseï¼‰ã€‚</strong>machine_arch_typeç”¨æ¥å¯»æ‰¾machineæè¿°ç¬¦ï¼›tag listç”¨äºè¿è¡Œæ—¶å‚æ•°çš„ä¼ é€’ã€‚éšç€å†…æ ¸çš„ä¸æ–­å‘å±•ï¼Œç›¸ä¿¡æœ‰ä¸€å¤©linux kernelä¼šå®Œå…¨æŠ›å¼ƒtag listçš„æœºåˆ¶ã€‚</p>

<p><2> åŒ¹é…platformï¼ˆmachineæè¿°ç¬¦ï¼‰</p>

<p>setup_machine_fdtå‡½æ•°çš„åŠŸèƒ½å°±æ˜¯æ ¹æ®Device Treeçš„ä¿¡æ¯ï¼Œæ‰¾åˆ°æœ€é€‚åˆçš„machineæè¿°ç¬¦ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">machine_desc</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">__init</span> <span style="color:#000">setup_machine_fdt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dt_phys</span><span style="color:#000;font-weight:bold">)</span> 
<span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">machine_desc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mdesc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mdesc_best</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">dt_phys</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">early_init_dt_verify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">phys_to_virt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dt_phys</span><span style="color:#000;font-weight:bold">)))</span> 
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">mdesc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">of_flat_dt_match_machine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mdesc_best</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">arch_get_next_mach</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">mdesc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>  
        <span style="color:#a40000">å‡ºé”™å¤„ç†</span> 
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#8f5902;font-style:italic">/* We really don&#39;t want to do this, but sometimes firmware provides buggy data */</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mdesc</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dt_fixup</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000">mdesc</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dt_fixup</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#000">early_init_dt_scan_nodes</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#8f5902;font-style:italic">/* Change machine number to match the mdesc we&#39;re using */</span> 
    <span style="color:#000">__machine_arch_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mdesc</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">mdesc</span><span style="color:#000;font-weight:bold">;</span> 
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>early_init_dt_scanå‡½æ•°æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼Œä¸€ä¸ªæ˜¯ä¸ºåç»­çš„DTB scanè¿›è¡Œå‡†å¤‡å·¥ä½œï¼Œå¦å¤–ä¸€ä¸ªæ˜¯è¿è¡Œæ—¶å‚æ•°ä¼ é€’ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/* of_flat_dt_match_machine - Iterate match tables to find matching machine.
</span><span style="color:#8f5902;font-style:italic"> * @default_match: A machine specific ptr to return in case of no match.
</span><span style="color:#8f5902;font-style:italic">* @get_next_compat: callback function to return next compatible match table.
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Iterate through machine match tables to find the best match for the machine
</span><span style="color:#8f5902;font-style:italic"> * compatible string in the FDT.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">__init</span> <span style="color:#000">of_flat_dt_match_machine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">default_match</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">get_next_compat</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">))</span></code></pre></div>
<p>of_flat_dt_match_machineæ˜¯åœ¨machineæè¿°ç¬¦çš„åˆ—è¡¨ä¸­scanï¼Œæ‰¾åˆ°æœ€åˆé€‚çš„é‚£ä¸ªmachineæè¿°ç¬¦ã€‚æˆ‘ä»¬é¦–å…ˆçœ‹å¦‚ä½•ç»„æˆmachineæè¿°ç¬¦çš„åˆ—è¡¨ã€‚å’Œä¼ ç»Ÿçš„æ–¹æ³•ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é™æ€å®šä¹‰çš„ã€‚DT_MACHINE_STARTå’ŒMACHINE_ENDç”¨æ¥å®šä¹‰ä¸€ä¸ªmachineæè¿°ç¬¦ã€‚ç¼–è¯‘çš„æ—¶å€™ï¼Œcompilerä¼šæŠŠè¿™äº›machine descriptoræ”¾åˆ°ä¸€ä¸ªç‰¹æ®Šçš„æ®µä¸­ï¼ˆ.arch.info.initï¼‰ï¼Œå½¢æˆmachineæè¿°ç¬¦çš„åˆ—è¡¨ã€‚machineæè¿°ç¬¦ç”¨ä¸‹é¢çš„æ•°æ®ç»“æ„æ¥æ ‡è¯†ï¼ˆåˆ é™¤äº†ä¸ç›¸å…³çš„memberï¼‰ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">machine_desc</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span>        <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">/* architecture number    */</span> 
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span>     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dt_compat</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* array of device tree &#39;compatible&#39; strings    */</span>
<span style="color:#a40000">â€¦â€¦</span>

   <span style="color:#000;font-weight:bold">};</span></code></pre></div>
<p>nræˆå‘˜å°±æ˜¯è¿‡å»ä½¿ç”¨çš„machine type IDã€‚å†…æ ¸machineæè¿°ç¬¦çš„tableæœ‰è‹¥å¹²ä¸ªentryï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„IDã€‚bootloaderä¼ é€’äº†machine type IDï¼ŒæŒ‡æ˜ä½¿ç”¨å“ªä¸€ä¸ªmachineæè¿°ç¬¦ã€‚ç›®å‰åŒ¹é…machineæè¿°ç¬¦ä½¿ç”¨compatible stringsï¼Œä¹Ÿå°±æ˜¯dt_compatæˆå‘˜ï¼Œè¿™æ˜¯ä¸€ä¸ªstring listï¼Œå®šä¹‰äº†è¿™ä¸ªmachineæ‰€æ”¯æŒçš„åˆ—è¡¨ã€‚åœ¨æ‰«æmachineæè¿°ç¬¦åˆ—è¡¨çš„æ—¶å€™éœ€è¦ä¸æ–­çš„è·å–ä¸‹ä¸€ä¸ªmachineæè¿°ç¬¦çš„compatibleå­—ç¬¦ä¸²çš„ä¿¡æ¯ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">__init</span> <span style="color:#000">arch_get_next_mach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">match</span><span style="color:#000;font-weight:bold">)</span> 
<span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">machine_desc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mdesc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__arch_info_begin</span><span style="color:#000;font-weight:bold">;</span> 
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">machine_desc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mdesc</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">__arch_info_end</span><span style="color:#000;font-weight:bold">)</span> 
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000">mdesc</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span> 
    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">match</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dt_compat</span><span style="color:#000;font-weight:bold">;</span> 
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">;</span> 
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>__arch_info_beginæŒ‡å‘machineæè¿°ç¬¦åˆ—è¡¨ç¬¬ä¸€ä¸ªentryã€‚é€šè¿‡mdesc++ä¸æ–­çš„ç§»åŠ¨machineæè¿°ç¬¦æŒ‡é’ˆï¼ˆNoteï¼šmdescæ˜¯staticçš„ï¼‰ã€‚matchè¿”å›äº†è¯¥machineæè¿°ç¬¦çš„compatible string listã€‚å…·ä½“åŒ¹é…çš„ç®—æ³•å€’æ˜¯å¾ˆç®€å•ï¼Œå°±æ˜¯æ¯”è¾ƒå­—ç¬¦ä¸²è€Œå·²ï¼Œä¸€ä¸ªæ˜¯root nodeçš„compatibleå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œä¸€ä¸ªæ˜¯machineæè¿°ç¬¦çš„compatibleå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå¾—åˆ†æœ€ä½çš„ï¼ˆæœ€åŒ¹é…çš„ï¼‰å°±æ˜¯æˆ‘ä»¬æœ€ç»ˆé€‰å®šçš„machine typeã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__init</span> <span style="color:#000">early_init_dt_scan_nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/* Retrieve various information from the /chosen node */</span>
    <span style="color:#8f5902;font-style:italic">/* æ‰«æ /chosen nodeï¼Œä¿å­˜è¿è¡Œæ—¶å‚æ•°ï¼ˆbootargsï¼‰åˆ°boot_command_lineï¼Œæ­¤å¤–ï¼Œè¿˜å¤„ç†initrdç›¸å…³çš„propertyï¼Œå¹¶ä¿å­˜åœ¨initrd_startå’Œinitrd_endè¿™ä¸¤ä¸ªå…¨å±€å˜é‡ä¸­ */</span> 
    <span style="color:#000">of_scan_flat_dt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">early_init_dt_scan_chosen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">boot_command_line</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">/* Initialize {size,address}-cells info */</span>
    <span style="color:#8f5902;font-style:italic">/* æ‰«ææ ¹èŠ‚ç‚¹ï¼Œè·å– {size,address}-cellsä¿¡æ¯ï¼Œå¹¶ä¿å­˜åœ¨dt_root_size_cellså’Œdt_root_addr_cellså…¨å±€å˜é‡ä¸­ */</span> 
    <span style="color:#000">of_scan_flat_dt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">early_init_dt_scan_root</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">/* Setup memory, calling early_init_dt_add_memory_arch */</span>
    <span style="color:#8f5902;font-style:italic">/* æ‰«æDTBä¸­çš„memory nodeï¼Œå¹¶æŠŠç›¸å…³ä¿¡æ¯ä¿å­˜åœ¨meminfoä¸­ï¼Œå…¨å±€å˜é‡meminfoä¿å­˜äº†ç³»ç»Ÿå†…å­˜ç›¸å…³çš„ä¿¡æ¯ã€‚*/</span> 
    <span style="color:#000">of_scan_flat_dt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">early_init_dt_scan_memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†DTBè½¬æ¢æˆèŠ‚ç‚¹æ˜¯device_nodeçš„æ ‘çŠ¶ç»“æ„ï¼Œä»¥ä¾¿åç»­æ–¹ä¾¿æ“ä½œã€‚å…·ä½“çš„ä»£ç ä½äºsetup_arch-&gt;unflatten_device_treeä¸­ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * unflatten_device_tree - create tree of device_nodes from flat blob
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * unflattens the device-tree passed by the firmware, creating the
</span><span style="color:#8f5902;font-style:italic"> * tree of struct device_node. It also fills the &#34;name&#34; and &#34;type&#34;
</span><span style="color:#8f5902;font-style:italic"> * pointers of the nodes so the normal device-tree walking functions
</span><span style="color:#8f5902;font-style:italic"> * can be used.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__init</span> <span style="color:#000">unflatten_device_tree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">__unflatten_device_tree</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">initial_boot_params</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">of_root</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#000">early_init_dt_alloc_memory_arch</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">/* Get pointer to &#34;/chosen&#34; and &#34;/aliases&#34; nodes for use everywhere */</span>
    <span style="color:#000">of_alias_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">early_init_dt_alloc_memory_arch</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>æˆ‘ä»¬ç”¨struct device_node æ¥æŠ½è±¡è®¾å¤‡æ ‘ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">device_node</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#a40000">ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span><span style="color:#000">device</span> <span style="color:#000">node</span> <span style="color:#000">name</span> 
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#a40000">å¯¹åº”</span><span style="color:#000">device_typeçš„å±æ€§</span> 
    <span style="color:#000">phandle</span> <span style="color:#000">phandle</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#a40000">å¯¹åº”è¯¥èŠ‚ç‚¹çš„</span><span style="color:#000">phandleå±æ€§</span> 
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">full_name</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#a40000">ä»â€œ</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#a40000">â€å¼€å§‹çš„ï¼Œè¡¨ç¤ºè¯¥</span><span style="color:#000">nodeçš„full</span> <span style="color:#000">path</span>
    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">fwnode_handle</span> <span style="color:#000">fwnode</span><span style="color:#000;font-weight:bold">;</span>  

    <span style="color:#204a87;font-weight:bold">struct</span>  <span style="color:#000">property</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">properties</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#a40000">è¯¥èŠ‚ç‚¹çš„å±æ€§åˆ—è¡¨</span> 
    <span style="color:#204a87;font-weight:bold">struct</span>  <span style="color:#000">property</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">deadprops</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#a40000">å¦‚æœéœ€è¦åˆ é™¤æŸäº›å±æ€§ï¼Œ</span><span style="color:#000">kernelå¹¶éçœŸçš„åˆ é™¤</span><span style="color:#a40000">ï¼Œè€Œæ˜¯æŒ‚å…¥åˆ°</span><span style="color:#000">deadpropsçš„åˆ—è¡¨</span> 
    <span style="color:#204a87;font-weight:bold">struct</span>  <span style="color:#000">device_node</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">parent</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#000">parent</span><span style="color:#a40000">ã€</span><span style="color:#000">childä»¥åŠsiblingå°†æ‰€æœ‰çš„device</span> <span style="color:#000">nodeè¿æ¥èµ·æ¥</span> 
    <span style="color:#204a87;font-weight:bold">struct</span>  <span style="color:#000">device_node</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">child</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">struct</span>  <span style="color:#000">device_node</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sibling</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">struct</span>  <span style="color:#000">kobject</span> <span style="color:#000">kobj</span><span style="color:#000;font-weight:bold">;</span>    
    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">_flags</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">void</span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">#if defined(CONFIG_SPARC)
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">path_component_name</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">unique_id</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">of_irq_controller</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">irq_trans</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">#endif
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">};</span></code></pre></div>
<p>unflatten_device_treeå‡½æ•°çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯æ‰«æDTBï¼Œå°†device nodeè¢«ç»„ç»‡æˆï¼š</p>

<p>1ã€global listã€‚å…¨å±€å˜é‡struct device_node *of_allnodeså°±æ˜¯æŒ‡å‘è®¾å¤‡æ ‘çš„global list</p>

<p>2ã€treeã€‚</p>

<p>è¿™äº›åŠŸèƒ½ä¸»è¦æ˜¯åœ¨__unflatten_device_treeå‡½æ•°ä¸­å®ç°ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹</p>

<p>å‚è€ƒæ–‡ç« ï¼š èœ—çªç§‘æŠ€ï¼Œwww.wowotech.netã€‚</p>

        </div>
      </div>
    </div>
  </div>
</div>

<section class="section has-background-light">
  <div class="container">
    <div class="columns">
      <div class="column has-text-centered">
        
<p class="subtitle is-size-6-mobile">
  å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ã€Œ <span class="text has-text-info">TONYçš„BLOG</span> ã€<br>å³æ—¶è·å–æœ€æ–°åŠ¨æ€
</p>
<p class="image is-96x96 has-image-centered">
  <img src="/images/wechat-qr-code.jpg">
</p>


      </div>
    </div>
</section>

<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2 has-text-centered">
        
        <article>
          <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "zhangqi336.github.io." + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
        
      </div>
    </div>
</section>

</main>
    <footer>
<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <p class="text is-uppercase has-text-grey">
        Â© 2018-2019 Stanley å¥½ç´§å¼ 
      </p>
      <p class="text">
        <a href='/zh/about' class="has-text-grey footer-link"> å…³äº</a>
        <a href='/zh/friends' class="has-text-grey footer-link">å‹æƒ…é“¾æ¥</a>
        <a href="/index.xml" class="has-text-grey footer-link">RSS</a>
      </p>
    </div>
  </div>
</footer>
</footer>

</body>

</html>